image: node:11

stages:
  - build
  - test
  - deploy

Build Jekyll:
  image: ruby:2.3
  tags: [shared-ci-docker]
  stage: build
  variables:
    JEKYLL_ENV: production
  script:
    - gem install jekyll bundler
    - jekyll build
    - find _site -type f -iname '*.jpg' -exec truncate -s 0 {} \;
    - find _site -type f -iname '*.png' -exec truncate -s 0 {} \;
  artifacts:
    expire_in: 1 day
    paths:
      - _site

Run tests:
  tags: [shared-ci-docker]
  stage: test
  dependencies: [Build Jekyll]
  script:
    - apt update
    - apt -y install xvfb gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
    - npm ci
    - npm test

Deploy qa:
  tags: [shared-ci-docker]
  stage: deploy
  when: manual
  dependencies: [Build Jekyll]
  variables:
    GIT_STRATEGY: none
    SITE_ID: caue24-qa.netlify.com
  script:
    - npx netlify-cli deploy --site=$SITE_ID --auth=$NETLIFY_ACCESS_TOKEN  --dir=./_site --prod
